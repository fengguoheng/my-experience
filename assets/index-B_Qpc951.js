import{d as De,y as Ie,z as Me,r as l,A as de,o as fe,B as Ve,c as k,j as z,f as d,C as $e,n as ze,D as We,E as re,G as ce,_ as He,H as Re,g as S,m as ve,w as y,I as Oe,v as Te,J as je,F as Ae,K,b as F,h as Z,e as Je,t as ee,p as Pe,i as Ke}from"./index-D-R_tuRR.js";import{u as Fe,L as qe}from"./useLoading-DVywwT7Q.js";import{r as se}from"./request-C9QAWmFR.js";const Ge="1.0.0",q=De({__name:"Danmaku",props:{danmus:{},channels:{default:0},autoplay:{type:Boolean,default:!0},loop:{type:Boolean,default:!1},useSlot:{type:Boolean,default:!1},useSuspendSlot:{type:Boolean,default:!1},debounce:{default:100},speeds:{default:100},randomChannel:{type:Boolean,default:!1},fontSize:{default:18},top:{default:10},right:{default:10},isSuspend:{type:Boolean,default:!1},extraStyle:{default:""}},emits:["list-end","play-end","dm-click","update:danmus"],setup(p,{expose:G,emit:_}){const W=p,m=Ie(),{danmus:Q,channels:x,autoplay:r,loop:N,useSlot:C,debounce:H,speeds:R,randomChannel:B,fontSize:O,top:E,right:f,isSuspend:i,extraStyle:b,useSuspendSlot:D}=Me(W),I=l(),c=l(),n=l(0),M=l(0);let T=null;const te=l(0),V=l(0),h=l(0),$=l(0),j=l(!1),w=l(!1),L=l({}),g=l([]),ae=l(10),v=de({get:()=>Q.value,set:t=>{_("update:danmus",t)}}),X=de(()=>x.value||te.value);function le(){ne(),i.value&&!C.value&&xe(),r.value&&A()}function ne(){n.value=I.value.offsetWidth,M.value=I.value.offsetHeight}function A(){w.value=!1,!T&&v.value.length&&(T=setInterval(()=>pe(),H.value))}function pe(){if(!w.value&&v.value.length)if(h.value>v.value.length-1+$.value){const t=c.value.children.length;N.value?(h.value>=v.value.length&&(_("list-end"),h.value=0),Y()):t<h.value&&oe()}else Y()}const J=l([]);function Y(t){t&&J.value.push(t);const a=N.value?h.value%v.value.length:h.value-$.value;let s=t||v.value[a],o=!1;J.value.length>$.value&&(s=J.value[$.value],o=!0);let e=document.createElement("div"),u=document.createElement("div");C.value?e=ge(s,a):(e.innerHTML=s,e.setAttribute("style",b.value),e.style.fontSize=`${O.value}px`,e.style.lineHeight=`${O.value}px`),e.style.opacity="0",e.classList.add("dm"),i.value&&D.value&&(u=ye(s,a).childNodes[1],u.classList.add("dm-suspend"),u.style.background="transparent",u.style.display="none",C.value?u&&e.childNodes[1]&&e.childNodes[1].appendChild(u):u&&e.appendChild(u)),c.value&&c.value.appendChild(e),We(()=>{V.value||(V.value=e.offsetHeight),x.value||(te.value=Math.floor(M.value/(V.value+E.value))),ae.value=u.offsetWidth+10+f.value;let P=me(e);if(P>=0){const ie=e.offsetWidth,Ee=V.value;e.classList.add("move"),e.dataset.index=`${a}`,e.style.top=P*(Ee+E.value)+"px",e.style.width=ie+"px",e.style.opacity="1",e.style.setProperty("--dm-scroll-width",`-${n.value+ie*2}px`),e.style.left=`${n.value}px`,e.style.animationDuration=`${n.value/R.value}s`,e.addEventListener("animationend",()=>{Number(e.dataset.index)===v.value.length-1&&!N.value&&_("play-end",Number(e.dataset.index)),c.value&&c.value.removeChild(e)},{once:!0}),h.value++,(t||o)&&(w.value=!1,$.value++)}else c.value.removeChild(e)})}function me(t){let a=[...Array(X.value).keys()];B.value&&(a=a.sort(()=>.5-Math.random()));for(const s of a){const o=L.value[s];if(o&&o.length)for(let e=0;e<o.length;e++){const u=he(o[e])-ae.value;if(u<=(t.offsetWidth-o[e].offsetWidth)*.88||u<=0)break;if(e===o.length-1)return L.value[s].push(t),t.addEventListener("animationend",()=>L.value[s].splice(0,1),{once:!0}),s%X.value}else return L.value[s]=[t],t.addEventListener("animationend",()=>L.value[s].splice(0,1),{once:!0}),s%X.value}return-1}function he(t){const a=t.offsetWidth||parseInt(t.style.width),s=t.getBoundingClientRect().right||c.value.getBoundingClientRect().right+a;return c.value.getBoundingClientRect().right-s}function ge(t,a){const s=l(document.createElement("div"));return re(ce("div",{onClick:()=>{_("dm-click",t,a)},onmouseover:o=>{if(!i.value)return;const e=o.target.closest(".dm");if(!e)return;const u=e.getElementsByClassName("dm-suspend")[0];i.value&&u&&(u.style.display="flex"),e.classList.add("pause"),g.value.includes(e)||(g.value.push(e),_e())},onmouseout:o=>{if(!i.value)return;const e=o.target.closest(".dm");if(!e)return;const u=e.getElementsByClassName("dm-suspend")[0];if(i.value&&u&&(u.style.display="none"),e.classList.remove("pause"),g.value.includes(e)){const P=g.value.indexOf(e);g.value.splice(P,1)}}},[m.dm&&m.dm({danmu:t,index:a})]),s.value),s.value.childNodes[0]}function ye(t,a){const s=l(document.createElement("div"));return re(ce("div",{},[m.suspend&&m.suspend({danmu:t,index:a})]),s.value),s.value.childNodes[0]}function _e(){document.body.addEventListener("mouseout",t=>{t.stopImmediatePropagation(),g.value.length&&(g.value.map(a=>{a.classList.remove("pause")}),g.value=[])},{once:!0})}function xe(){let t=[];c.value.addEventListener("mousemove",a=>{let s=a.target;if(s.className.includes("dm")||(s=s.closest(".dm")||s),!s.className.includes("dm"))return;const o=s.getElementsByClassName("dm-suspend")[0];i.value&&o&&(o.style.display="flex"),s.classList.add("pause"),t.push(s)}),c.value.addEventListener("mouseout",a=>{let s=a.target;if(s.className.includes("dm")||(s=s.closest(".dm")||s),!s.className.includes("dm"))return;const o=s.getElementsByClassName("dm-suspend")[0];i.value&&o&&(o.style.display="none"),s.classList.remove("pause"),t.forEach(e=>{e.classList.remove("pause")}),t=[]})}function oe(){clearInterval(T),T=null}function be(){V.value=0,le()}function ue(){L.value={},c.value.innerHTML="",w.value=!0,j.value=!1,oe(),h.value=0,g.value=[]}function we(){w.value=!0}function Se(){j.value=!1}function Ce(){j.value=!0}function Le(t){if(h.value>=v.value.length-1)return v.value.push(t),A(),v.value.length-1;{const a=h.value%v.value.length;return v.value.splice(a,0,t),A(),a-1}}function ke(t){return v.value.push(t),v.value.length-1}function Ue(){ne();const t=c.value.getElementsByClassName("dm");for(let a=0;a<t.length;a++){const s=t[a];s.style.setProperty("--dm-scroll-width",`-${n.value+s.offsetWidth*2}px`),s.style.left=`${n.value}px`,s.style.animationDuration=`${n.value/R.value}s`}}function Ne(){return!w.value}function Be(){return J.value}return fe(()=>{console.log(`%c danmaku-vue %c V${Ge} `,"padding: 2px 1px; border-radius: 3px 0 0 3px; color: #fff; background: #606060; font-weight: bold;","padding: 2px 1px; border-radius: 0 3px 3px 0; color: #fff; background: #42c02e; font-weight: bold;"),le()}),Ve(()=>{ue()}),G({add:Le,push:ke,insert:Y,play:A,pause:we,reset:be,resize:Ue,show:Se,hide:Ce,clear:ue,getPlayState:Ne,getInsertList:Be}),(t,a)=>(k(),z("div",{ref_key:"container",ref:I,class:"danmaku-container"},[d("div",{ref_key:"dmContainer",ref:c,class:ze(["danmus",{show:!j.value},{paused:w.value}])},[$e(t.$slots,"default")],2)],512))}});q.install=p=>{p.component(q.__name,q)};const Qe=()=>se({url:"/message/message"}),Xe=p=>se({url:"/message/save",method:"post",data:p}),Ye=p=>se({url:"/message/send",method:"post",data:p}),U=p=>(Pe("data-v-4c3a356b"),p=p(),Ke(),p),Ze=U(()=>d("span",{style:{color:"#3fa8db","font-weight":"bold","font-size":"20px"}},"时空留痕",-1)),es={class:"avatar-box"},ss=["src"],ts={class:"dialog-footer"},as={class:"box-xk"},ls=U(()=>d("div",{id:"stars"},null,-1)),ns=U(()=>d("div",{id:"stars2"},null,-1)),os=U(()=>d("div",{id:"stars3"},null,-1)),us=U(()=>d("div",{class:"title"},"留言板",-1)),is={class:"danmu-item"},ds=["src"],rs={class:"box-text"},cs={style:{color:"#aac9fa"}},vs={key:0,style:{color:"#b0b2b5","font-weight":"bold"}},fs={key:1,color:"#8597b4"},ps=U(()=>d("div",{class:"danmu-suspend"},null,-1)),ms={__name:"index",setup(p){const{isLoading:G}=Fe(),_=l([{userUrl:"",content:"",name:""}]),W=async()=>{const f=await Qe();_.value=f.data};Re(async()=>{await W(),H()});const m=l(!1),Q=()=>{m.value=!1},x=l(""),r=l({userUrl:"",name:""}),N=()=>{const f=window.localStorage.getItem("messageUser");if(f)r.value=JSON.parse(f);else return},C=l({}),H=()=>{const f=window.localStorage.getItem("messageUser");if(!f)return;const{userUrl:i}=JSON.parse(f);let b=_.value.find(D=>D.userUrl===i);C.value=b};fe(()=>{N()});const R=f=>{r.value.userUrl=f.data},B=l(0),O=async()=>{r.value.name.trim("")&&r.value.userUrl?(await Xe(r.value),K.success("可以发送留言了!"),window.localStorage.setItem("messageUser",JSON.stringify(r.value)),B.value=1,m.value=!1):K("名标头像，时空留痕")},E=async()=>{if(r.value.name.trim("")&&r.value.userUrl){if(!x.value){K("时空留痕，缺你一言");return}await Ye({...r.value,content:x.value}),await W(),B.value===1&&H(),B.value++,K.success("感谢你在我生命里留下痕迹"),x.value=""}else m.value=!0};return(f,i)=>{const b=F("el-button"),D=F("el-upload"),I=F("el-input"),c=F("el-dialog");return k(),z(Ae,null,[S(qe,{isLoading:ve(G)},null,8,["isLoading"]),S(c,{modelValue:m.value,"onUpdate:modelValue":i[1]||(i[1]=n=>m.value=n),style:{"background-color":"#131f2b"},width:"500px","before-close":f.handleClose,center:"","show-close":!1},{header:y(()=>[Ze]),footer:y(()=>[d("div",ts,[S(b,{onClick:Q},{default:y(()=>[Z("取消")]),_:1}),S(b,{type:"primary",onClick:O},{default:y(()=>[Z("确定")]),_:1})])]),default:y(()=>[d("div",es,[S(D,{action:"/prod-api/web/message/fileUpload","show-file-list":!1,class:"avatar-uploader",style:{height:"100px",width:"100px","border-radius":"50%"},"on-success":R},{default:y(()=>[r.value.userUrl?(k(),z("img",{key:0,src:r.value.userUrl,class:"avatar"},null,8,ss)):(k(),Je(b,{key:1,style:{"background-color":"#131f2b",border:"none",margin:"33px 0px 0px 26px","font-size":"30px"}},{default:y(()=>[Z("+")]),_:1}))]),_:1})]),S(I,{modelValue:r.value.name,"onUpdate:modelValue":i[0]||(i[0]=n=>r.value.name=n),placeholder:"为留言起个名字",clearable:"",size:"large",style:{width:"220px","margin-left":"124px","background-color":"#fff","margin-bottom":"6px"},class:"lyinput"},null,8,["modelValue"])]),_:1},8,["modelValue","before-close"]),d("div",as,[ls,ns,os,us,d("div",{class:"biu",onKeyup:Oe(E,["enter"])},[Te(d("input",{type:"text","onUpdate:modelValue":i[2]||(i[2]=n=>x.value=n),placeholder:"总要留下点什么才好",class:"input"},null,512),[[je,x.value]]),d("i",{class:"iconfont icon-fasongliuyan icon",onClick:E})],32),S(ve(q),{danmus:_.value,class:"danmus",autoplay:"",loop:"",useSlot:"",useSuspendSlot:"",isSuspend:"",randomChannel:"true"},{dm:y(({danmu:n})=>{var M;return[d("div",is,[d("img",{class:"danmu-item--avatar",src:n.userUrl,alt:""},null,8,ds),d("div",rs,[d("span",cs,ee(n.name)+":",1),((M=C.value)==null?void 0:M.userUrl)===(n==null?void 0:n.userUrl)?(k(),z("span",vs,ee(n.content),1)):(k(),z("span",fs,ee(n.content),1))])])]}),suspend:y(()=>[ps]),_:1},8,["danmus"])])],64)}}},_s=He(ms,[["__scopeId","data-v-4c3a356b"]]);export{_s as default};
